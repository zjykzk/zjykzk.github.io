<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Mongodb on 老K随笔</title>
    <link>http://zjykzk.github.io/tags/mongodb/</link>
    <description>Recent content in Mongodb on 老K随笔</description>
    <generator>Hugo -- gohugo.io</generator>
    <managingEditor>zhangkai.zju@gmail.com (zenk)</managingEditor>
    <webMaster>zhangkai.zju@gmail.com (zenk)</webMaster>
    <copyright>(c) 2017 zenk.</copyright>
    <lastBuildDate>Fri, 20 Jul 2018 16:18:23 +0800</lastBuildDate>
    <atom:link href="http://zjykzk.github.io/tags/mongodb/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>mongodb索引</title>
      <link>http://zjykzk.github.io/post/cs/mongodb/</link>
      <pubDate>Fri, 20 Jul 2018 16:18:23 +0800</pubDate>
      <author>zhangkai.zju@gmail.com (zenk)</author>
      <guid>http://zjykzk.github.io/post/cs/mongodb/</guid>
      <description>

&lt;h2 id=&#34;默认索引&#34;&gt;默认索引&lt;/h2&gt;

&lt;p&gt;每个文档默认都有一个字段&lt;code&gt;_id&lt;/code&gt;，这个字段会自动生成唯一索引，这个索引无法删除。这个字段的值可以是用户指定，如果不指定mongodb会自动生成。&lt;/p&gt;

&lt;p&gt;生成的规则：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;|&amp;lt;-- 4 --&amp;gt;|&amp;lt;- 3 -&amp;gt;|&amp;lt;-2-&amp;gt;|&amp;lt;-- 3 --&amp;gt;|
+---------+-------+-----+---------+
|unix time| mid   | pid | counter |
+---------+-------+-----+---------+
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;包含四个字段：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;unix时间戳，4个字节&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;机器id，3个字节&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;进程id，2个字节&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;计数器，3个字节，自增，从一个随机数开始&lt;br /&gt;
&lt;br /&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;索引类型&#34;&gt;索引类型&lt;/h2&gt;

&lt;h3 id=&#34;单字段索引&#34;&gt;单字段索引&lt;/h3&gt;

&lt;p&gt;文档中的任何字段或者子文档的字段都可以当作索引，字段的值也可以是一个文档。&lt;/p&gt;

&lt;h3 id=&#34;复合索引-compound-index&#34;&gt;复合索引（compound index）&lt;/h3&gt;

&lt;p&gt;一个文档中的多个字段组成一个索引。最多支持31个字段。&lt;/p&gt;

&lt;h4 id=&#34;prefixes&#34;&gt;Prefixes&lt;/h4&gt;

&lt;p&gt;当查询的条件是索引的前面几个字段时会使用复合索引。&lt;/p&gt;

&lt;p&gt;比如：有索引&lt;code&gt;{a:1,b:1,c:1}&lt;/code&gt;，查询条件&lt;code&gt;{a:&amp;quot;a&amp;quot;,b:&amp;quot;b&amp;quot;}&lt;/code&gt;就会使用这个索引，但是&lt;code&gt;{b:&amp;quot;b&amp;quot;}&lt;/code&gt;这样的查询条件就无法使用。&lt;/p&gt;

&lt;h4 id=&#34;排序&#34;&gt;排序&lt;/h4&gt;

&lt;p&gt;索引的顺序先按第一个字段排序，如果第一个字段相等，按照第二个字段排序，依次类推后面的字段顺序。因此，&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;如果有以下索引&lt;code&gt;{a:1,b:1}&lt;/code&gt;，支持排序&lt;code&gt;{a:-1,b:-1}/{a:1:b:1}&lt;/code&gt;，不支持排序&lt;code&gt;{a:-1:b:1}/{a:1:b:-1}&lt;/code&gt;。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;只支持&lt;strong&gt;Prefixes&lt;/strong&gt;的排序。&lt;br /&gt;
&lt;br /&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;多值索引-multikey-index&#34;&gt;多值索引（multikey index）&lt;/h3&gt;

&lt;p&gt;字段的值是一个数组，就会自动把这个索引变成多值索引，支持范围查询。&lt;/p&gt;

&lt;h3 id=&#34;地理空间索引-geospatial-index&#34;&gt;地理空间索引（geospatial index）&lt;/h3&gt;

&lt;p&gt;包含两种索引：2d/2dsphere index&lt;/p&gt;

&lt;h3 id=&#34;文本索引-text-indexes&#34;&gt;文本索引（text indexes）&lt;/h3&gt;

&lt;p&gt;作用于值是字符串或者是字符串数组的字段，查询字段中是否包含查询字符串。&lt;/p&gt;

&lt;h3 id=&#34;哈希索引-hashed-indexes&#34;&gt;哈希索引（hashed indexes）&lt;/h3&gt;

&lt;p&gt;用于基于hash的sharding。&lt;/p&gt;

&lt;h3 id=&#34;交集索引-index-intersection&#34;&gt;交集索引（index intersection）&lt;/h3&gt;

&lt;p&gt;如果查询条件中出现使用了多个索引，包括&lt;strong&gt;Prefixes&lt;/strong&gt;索引。mongodb可能会使用多个索引进行查询，然后取交集。是否使用了这个索引，可以通过&lt;code&gt;explain&lt;/code&gt;来确定。&lt;/p&gt;

&lt;p&gt;当查询需要排序，同时排序的字段需要的索引和查询条件无法组成一个或者部分&lt;code&gt;query predicate&lt;/code&gt;，那就无法使用这个索引了。&lt;/p&gt;

&lt;p&gt;比如：有索引&lt;code&gt;{a:1}/{b:1,c:1}&lt;/code&gt;，查询&lt;code&gt;db.col.find({a:&#39;a&#39;}).sort({b:1})&lt;/code&gt;无法使用，虽然排序中包含字段&lt;code&gt;b&lt;/code&gt;，但是查询条件中无法使用这个索引；而查询&lt;code&gt;db.col.find({a:&#39;a&#39;,b:&#39;b&#39;}).sort({c:1})&lt;/code&gt;却可以使用两个索引，这是因为查询条件中有&lt;code&gt;{b:&#39;b&#39;}&lt;/code&gt;和排序字段&lt;code&gt;{c:1}&lt;/code&gt;，索引&lt;code&gt;{b:1,c:1}&lt;/code&gt;组成部分查询条件。&lt;/p&gt;

&lt;h2 id=&#34;索引的属性&#34;&gt;索引的属性&lt;/h2&gt;

&lt;h3 id=&#34;唯一性&#34;&gt;唯一性&lt;/h3&gt;

&lt;p&gt;可以指定一个索引唯一。&lt;/p&gt;

&lt;h3 id=&#34;部分索引-partial-indexes&#34;&gt;部分索引（partial indexes）&lt;/h3&gt;

&lt;p&gt;只索引满足条件的文档，它是稀疏索引的超集，相比稀疏索引采用部分索引。&lt;/p&gt;

&lt;h3 id=&#34;稀疏索引-sparse-indexes&#34;&gt;稀疏索引（sparse indexes）&lt;/h3&gt;

&lt;p&gt;只索引存在该字段值的文档。&lt;/p&gt;

&lt;h4 id=&#34;ttl-time-to-live-索引&#34;&gt;TTL（time to live）索引&lt;/h4&gt;

&lt;p&gt;过期索引，针对值为日期或者日期数组的字段。如果字段值超过了过期日期，就会自动删除。过期时间可以动态修改的，有两种方式指定过期行为：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;指定字段日期和过期时长。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;指定过期日期，同时过期时长为0。&lt;br /&gt;
&lt;br /&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;优化&#34;&gt;优化&lt;/h2&gt;

&lt;ol&gt;
&lt;li&gt;如果查询的内容和条件都只引用索引时，那么只需要扫描索引数据，不需要查询文档内容。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;background构建，增量式构建索引。构建时，可以处理其他请求，但是构建索引的请求会被阻塞。&lt;br /&gt;
&lt;br /&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;限制&#34;&gt;限制&lt;/h2&gt;

&lt;ol&gt;
&lt;li&gt;每个index entry的大小不能超过1024字节，超过这个大小的文档会无法插入。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;每个collection最多拥有64个索引。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;索引名字长度 最多128字符，名字规范：&lt;database name&gt;.&lt;collection name&gt;.$&lt;index name&gt; ，其中index name，默认是字段名字+类型，这个名字可以在创建索引的时候指定。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;复合索引最多允许使用31个字段。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;查询条件不能同时使用文本索引和地理空间索引。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;2dsphere index的值只能是几何数据。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;多值索引无法做cover query优化，比如：字段&lt;code&gt;{a:[{b:1},{b:2}]}&lt;/code&gt;。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;地理空间索引无法做cover query优化。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;构建索引的请求执行时构建会有一个内存限制，超过这个限制会使用临时文件。可以阀值可以修改。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;text/2d/geoHaystack索引无法使用collation。&lt;br /&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
    </item>
    
  </channel>
</rss>
